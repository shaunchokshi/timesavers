#cloud-config

hostname: "<<${HOSTNAME}>>"
fqdn: "<<${HOSTNAME}>>"

package_update: true
package_upgrade: false

packages:
  - openssh-server
  - curl
  - wget
  - git
  - net-tools
  - zsh
  - wireguard
  - wireguard-tools
  - ca-certificates
  - gnupg
  - unzip
  - cifs-utils
  - nfs-common
  - nfs-kernel-server
  - eza
  - bat
  - htop
  - pwgen
  - python3-pygments

users:
  - name: root
    shell: /bin/bash
    ssh_authorized_keys:
      - "<<${ROOT_SSH_PUBKEY_1}>>"
      # - "<<${ROOT_SSH_PUBKEY_2}>>"

  - name: "<<${STANDARD_USERNAME}>>"
    gecos: "<<${STANDARD_USERNAME}>>"
    groups: [sudo]
    shell: /bin/bash
    lock_passwd: true
    sudo: "ALL=(ALL) NOPASSWD:ALL"
    ssh_authorized_keys:
      - "<<${USER_SSH_PUBKEY_1}>>"
      # - "<<${USER_SSH_PUBKEY_2}>>"

write_files:
  # --- .bashrc placeholders ---------------------------------------------------
  - path: /root/.bashrc
    permissions: "0644"
    owner: root:root
    content: |
      # Root .bashrc
      export HISTCONTROL=ignoredups:erasedups
      alias ll='ls -alF'
      # BEGIN USER CONTENT:
      <<${ROOT_BASHRC_FROM_FILE:ROOT_BASHRC_PATH}>>
      # END USER CONTENT

  - path: /home/<<${STANDARD_USERNAME}>>/.bashrc
    permissions: "0644"
    owner: <<${STANDARD_USERNAME}>>:<<${STANDARD_USERNAME}>>
    content: |
      # User .bashrc
      export HISTCONTROL=ignoredups:erasedups
      alias ll='ls -alF'
      # BEGIN USER CONTENT:
      <<${USER_BASHRC_FROM_FILE:USER_BASHRC_PATH}>>
      # END USER CONTENT

  # --- systemd socket override: move ssh off 22 -> 2522 -----------------------
  - path: /etc/systemd/system/ssh.socket.d/listen.conf
    permissions: "0644"
    owner: root:root
    content: |
      [Socket]
      ListenStream=
      ListenStream=2522

  # --- sshd drop-in hardening + WG-gated forwarding ---------------------------
  - path: /etc/ssh/sshd_config.d/99-cloud-init.conf
    permissions: "0644"
    owner: root:root
    content: |
      PasswordAuthentication no
      KbdInteractiveAuthentication no
      ChallengeResponseAuthentication no
      PubkeyAuthentication yes
      UsePAM yes
      PermitRootLogin prohibit-password

      # Default: no tunneling/forwarding
      AllowTcpForwarding no
      PermitTunnel no
      X11Forwarding no
      AllowAgentForwarding yes

      # Allow forwarding ONLY if connection terminates on WireGuard IP
      Match LocalAddress <<${WG_LOCAL_IP}>>
        AllowTcpForwarding yes
        PermitTunnel yes

  # --- store a local .env template on the box (optional convenience) ----------
  - path: /opt/bootstrap/.env-template
    permissions: "0644"
    owner: root:root
    content: |
      # This file is informational: cloud-init does not source it.
      # It mirrors your local env-template structure.
      STANDARD_USERNAME=<<${STANDARD_USERNAME}>>
      ROOT_SSH_PUBKEY_1=<<${ROOT_SSH_PUBKEY_1}>>
      USER_SSH_PUBKEY_1=<<${USER_SSH_PUBKEY_1}>>
      WG_ADDRESS_CIDR=<<${WG_ADDRESS_CIDR}>>
      WG_LOCAL_IP=<<${WG_LOCAL_IP}>>
      WG_LISTEN_PORT=<<${WG_LISTEN_PORT}>>
      WG_PEER_PUBLIC_KEY=<<${WG_PEER_PUBLIC_KEY}>>
      WG_PEER_ENDPOINT_HOST_OR_IP=<<${WG_PEER_ENDPOINT_HOST_OR_IP}>>
      WG_PEER_ENDPOINT_PORT=<<${WG_PEER_ENDPOINT_PORT}>>
      WG_ALLOWED_IPS=<<${WG_ALLOWED_IPS}>>

  # --- fontconfig default monospace -> SpaceMonoNerdFontMono ------------------
  - path: /etc/fonts/local.conf
    permissions: "0644"
    owner: root:root
    content: |
      <?xml version="1.0"?>
      <!DOCTYPE fontconfig SYSTEM "fonts.dtd">
      <fontconfig>
        <alias>
          <family>monospace</family>
          <prefer>
            <family>SpaceMonoNerdFontMono</family>
          </prefer>
        </alias>
      </fontconfig>

  # BEGIN_STORBOX
  # --- Hetzner Storage Box CIFS credentials file ------------------------------
  - path: /root/.secrets/smb-STORBOX-<<${STORBOX_MAIN}>>
    permissions: "0600"
    owner: root:root
    content: |
      username=<<${STORBOX_SUBACCT}>>
      password=<<${STORBOX_SUBACCT_PASSWORD}>>
  # END_STORBOX

runcmd:
  # --- tiny helper: make secrets dir + base mount dir -------------------------
  - [ bash, -lc, "mkdir -p /root/.secrets && chmod 700 /root/.secrets" ]
  - [ bash, -lc, "mkdir -p /mnt/STORBOX" ]

  # --- install GitHub CLI (gh) from official repo -----------------------------
  - |
    bash -lc '
      set -euo pipefail
      if ! command -v gh >/dev/null 2>&1; then
        mkdir -p /etc/apt/keyrings
        curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg \
          | dd of=/etc/apt/keyrings/githubcli-archive-keyring.gpg
        chmod go+r /etc/apt/keyrings/githubcli-archive-keyring.gpg
        echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" \
          > /etc/apt/sources.list.d/github-cli.list
        apt-get update -y
        apt-get install -y gh
      fi
    '

  # --- try secpwgen; fall back is pwgen (already installed) -------------------
  - |
    bash -lc '
      set -euo pipefail
      apt-get update -y
      apt-get install -y secpwgen || true
    '

  # --- terminfo: ghostty + kitty ---------------------------------------------
  - |
    bash -lc '
      set -euo pipefail
      tmpdir="$(mktemp -d)"
      cd "$tmpdir"
      curl -fsSLo xterm-ghostty https://github.com/shaunchokshi/timesavers/raw/refs/heads/main/xterm-ghostty
      curl -fsSLo xterm-kitty   https://github.com/shaunchokshi/timesavers/raw/refs/heads/main/xterm-kitty
      tic -x xterm-ghostty
      tic -x xterm-kitty
      rm -rf "$tmpdir"
    '

  # --- WireGuard keys + wg0.conf ---------------------------------------------
  - [ bash, -lc, "umask 077; mkdir -p /etc/wireguard" ]
  - path: /etc/wireguard/wg0.conf.template
    permissions: "0600"
    owner: root:root
    content: |
      [Interface]
      Address = <<${WG_ADDRESS_CIDR}>>
      ListenPort = <<${WG_LISTEN_PORT}>>
      PrivateKey = __FILL_ME_PRIVATE_KEY__

      [Peer]
      PublicKey = <<${WG_PEER_PUBLIC_KEY}>>
      PresharedKey = __FILL_ME_PRESHARED_KEY__
      AllowedIPs = <<${WG_ALLOWED_IPS}>>
      Endpoint = <<${WG_PEER_ENDPOINT_HOST_OR_IP}>>:<<${WG_PEER_ENDPOINT_PORT}>>
      PersistentKeepalive = 25

  - path: /usr/local/sbin/bootstrap_sensitive.sh
    permissions: "0700"
    owner: root:root
    content: |
      #!/usr/bin/env bash
      set -euo pipefail

      BOLD="\e[1m"; GREEN="\e[32m"; YELLOW="\e[33m"; RED="\e[31m"; RESET="\e[0m"

      die() { echo -e "${RED}ERROR:${RESET} $*" >&2; exit 1; }
      have() { command -v "$1" >/dev/null 2>&1; }

      if [ "$(id -u)" -ne 0 ]; then
        die "Run as root (sudo -i or sudo /usr/local/sbin/bootstrap_sensitive.sh)"
      fi

      echo -e "${BOLD}Sensitive bootstrap:${RESET} WireGuard + optional StorBox"

      # ---- WireGuard secrets -------------------------------------------------
      mkdir -p /etc/wireguard
      chmod 700 /etc/wireguard

      WG_CONF="/etc/wireguard/wg0.conf"
      WG_TEMPLATE="/etc/wireguard/wg0.conf.template"
      WG_PRIV="/etc/wireguard/privatekey"
      WG_PSK="/etc/wireguard/presharedkey"

      if [ -f "${WG_CONF}" ]; then
        echo -e "${YELLOW}WireGuard config already exists:${RESET} ${WG_CONF}"
      else
        [ -f "${WG_TEMPLATE}" ] || die "Missing template: ${WG_TEMPLATE}"
        have wg || die "'wg' not found; is wireguard-tools installed?"

        echo -e "${BOLD}WireGuard keys${RESET}"
        read -r -p "Generate a NEW WireGuard private key on this host? [y/N] " gen_priv
        if [[ "${gen_priv,,}" == "y" ]]; then
          umask 077
          wg genkey > "${WG_PRIV}"
          chmod 600 "${WG_PRIV}"
          echo -e "${GREEN}Generated:${RESET} ${WG_PRIV}"
          echo -e "${YELLOW}Public key (share with peer):${RESET}"
          wg pubkey < "${WG_PRIV}"
        else
          echo -e "${YELLOW}Paste the WireGuard PRIVATE key now (will not echo):${RESET}"
          read -r -s priv_in
          echo
          [ -n "${priv_in}" ] || die "Empty private key."
          umask 077
          printf "%s\n" "${priv_in}" > "${WG_PRIV}"
          chmod 600 "${WG_PRIV}"
        fi

        read -r -p "Generate a NEW WireGuard preshared key (PSK) on this host? [y/N] " gen_psk
        if [[ "${gen_psk,,}" == "y" ]]; then
          umask 077
          wg genpsk > "${WG_PSK}"
          chmod 600 "${WG_PSK}"
          echo -e "${GREEN}Generated:${RESET} ${WG_PSK}"
          echo -e "${YELLOW}PSK (share securely with peer):${RESET}"
          cat "${WG_PSK}"
        else
          echo -e "${YELLOW}Paste the WireGuard PRESHARED key (PSK) now (will not echo):${RESET}"
          read -r -s psk_in
          echo
          [ -n "${psk_in}" ] || die "Empty PSK."
          umask 077
          printf "%s\n" "${psk_in}" > "${WG_PSK}"
          chmod 600 "${WG_PSK}"
        fi

        # Render final wg0.conf from template
        umask 077
        sed \
          -e "s|__FILL_ME_PRIVATE_KEY__|$(cat "${WG_PRIV}")|g" \
          -e "s|__FILL_ME_PRESHARED_KEY__|$(cat "${WG_PSK}")|g" \
          "${WG_TEMPLATE}" > "${WG_CONF}"
        chmod 600 "${WG_CONF}"
        echo -e "${GREEN}Wrote:${RESET} ${WG_CONF}"
      fi

      read -r -p "Bring up WireGuard now (wg-quick@wg0)? [y/N] " upwg
      if [[ "${upwg,,}" == "y" ]]; then
        systemctl enable --now wg-quick@wg0
        echo -e "${GREEN}WireGuard is up.${RESET}"
      fi

      # ---- Optional StorBox credentials --------------------------------------
      # We do not store passwords in cloud-init. If fstab entry exists, we create
      # the credentials file it references. If not, we can add one interactively.
      echo
      read -r -p "Configure Hetzner Storage Box CIFS credentials now? [y/N] " dostor
      if [[ "${dostor,,}" == "y" ]]; then
        read -e -i "h0" -p "STORBOX_MAIN (e.g., h0): " STORBOX_MAIN
        read -e -i "" -p "STORBOX_SUBACCT (e.g., u12345-sub1): " STORBOX_SUBACCT
        read -e -i "" -p "STORBOX_SUBURI (e.g., u12345-sub1.your-storagebox.de/u12345-sub1): " STORBOX_SUBURI
        echo -e "${YELLOW}Storage Box password (will not echo):${RESET}"
        read -r -s STORBOX_SUBACCT_PASSWORD
        echo
        [ -n "${STORBOX_SUBACCT_PASSWORD}" ] || die "Empty StorBox password."

        mkdir -p /root/.secrets
        chmod 700 /root/.secrets
        CRED_FILE="/root/.secrets/smb-STORBOX-${STORBOX_MAIN}"
        umask 077
        cat > "${CRED_FILE}" <<EOF
      username=${STORBOX_SUBACCT}
      password=${STORBOX_SUBACCT_PASSWORD}
      EOF
        chmod 600 "${CRED_FILE}"
        echo -e "${GREEN}Wrote:${RESET} ${CRED_FILE}"

        MNT="/mnt/STORBOX/${STORBOX_MAIN}"
        mkdir -p "${MNT}"

        # Add fstab entry if missing
        if ! grep -q "smb-STORBOX-${STORBOX_MAIN}" /etc/fstab; then
          cat >> /etc/fstab <<EOF

      # hetzner storage box ${STORBOX_MAIN} with sub account ${STORBOX_SUBACCT};
      # it will be accessible via ${STORBOX_SUBURI} and the credentials
      # will need to be copied from \$HOME/.secrets/smb-STORBOX-${STORBOX_MAIN}
      //${STORBOX_SUBURI} ${MNT} cifs credentials=${CRED_FILE},uid=1000,gid=1000,iocharset=utf8,file_mode=0777,dir_mode=0777,_netdev,noserverino 0 0
      EOF
          echo -e "${GREEN}Added fstab entry.${RESET}"
        else
          echo -e "${YELLOW}fstab already has a StorBox entry for:${RESET} ${STORBOX_MAIN}"
        fi

        read -r -p "Mount now (mount -a)? [y/N] " mountnow
        if [[ "${mountnow,,}" == "y" ]]; then
          mount -a || true
          echo -e "${GREEN}Mount attempted. Check:${RESET} mount | grep STORBOX || true"
        fi
      fi

      echo
      echo -e "${GREEN}Done.${RESET} You can rerun this script anytime: /usr/local/sbin/bootstrap_sensitive.sh"

  # --- Timesavers repo + zsh wiring for root + STANDARD_USERNAME -------------
  - |
    bash -lc '
      set -euo pipefail

      setup_timesavers_for_user() {
        local user="$1"
        local home
        home="$(getent passwd "$user" | cut -d: -f6)"
        local proj="${home}/devspace/myprojects"

        mkdir -p "${proj}"
        if [ ! -d "${proj}/timesavers/.git" ]; then
          sudo -u "$user" git clone https://github.com/shaunchokshi/timesavers.git "${proj}/timesavers"
        fi

        # Hardlink-based mirror of zsh config
        cp -lr "${proj}/timesavers/cloud-init/zsh-custom" "${home}/.zsh-custom"
        ln -sf "${proj}/timesavers/cloud-init/zshrc" "${home}/.zshrc"
        ln -snf "${proj}/timesavers" "${home}/timesavers"
        chown -R "${user}:${user}" "${home}/.zsh-custom" "${home}/.zshrc" "${home}/timesavers"
      }

      # Oh-my-zsh via standard curl installer, per user
      install_omz_for_user() {
        local user="$1"
        local home
        home="$(getent passwd "$user" | cut -d: -f6)"
        sudo -u "$user" sh -c "RUNZSH=no CHSH=no KEEP_ZSHRC=yes \
          $(command -v curl) -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh | sh"
        chsh -s /usr/bin/zsh "$user" || true
      }

      install_omz_for_user root
      install_omz_for_user "<<${STANDARD_USERNAME}>>"

      setup_timesavers_for_user root
      setup_timesavers_for_user "<<${STANDARD_USERNAME}>>"

      # Fonts from timesavers (use root clone path)
      ROOT_HOME="/root"
      FONT_SRC="${ROOT_HOME}/devspace/myprojects/timesavers/cloud-init"
      install -d /usr/share/fonts/truetype
      cp "${FONT_SRC}"/SpaceMonoNerdFontMono-*.ttf /usr/share/fonts/truetype/ || true
      fc-cache -f
    '

  # --- apply SSH socket override ---------------------------------------------
  - [ bash, -lc, "systemctl daemon-reload" ]
  - [ bash, -lc, "systemctl restart ssh.socket" ]
  - [ bash, -lc, "ss -tlpn | grep ':2522 ' || true" ]

  # BEGIN_STORBOX_FSTAB
  # --- Hetzner Storage Box fstab entry ---------------------------------------
  - |
    bash -lc 'cat >> /etc/fstab <<EOF
    # hetzner storage box <<${STORBOX_MAIN}>> with sub account <<${STORBOX_SUBACCT>>;
    # it will be accessible via <<${STORBOX_SUBURI}>> and the credentials
    # will need to be copied from \$HOME/.secrets/smb-STORBOX-<<${SSH_TAG}>>

    //<<${STORBOX_SUBURI}>> /mnt/STORBOX/<<${STORBOX_MAIN}>> cifs credentials=/root/.secrets/smb-STORBOX-<<${STORBOX_MAIN}>>,uid=1000,gid=1000,iocharset=utf8,file_mode=0777,dir_mode=0777,_netdev,noserverino 0 0
    EOF'
  - [ bash, -lc, "mkdir -p /mnt/STORBOX/<<${STORBOX_MAIN}>>" ]
  - [ bash, -lc, "mount -a || true" ]
  # END_STORBOX_FSTAB
# Remind about sensitive bootstrap if wg0.conf doesn't exist yet
if [ -t 1 ] && [ -x /usr/local/sbin/bootstrap_sensitive.sh ] && [ ! -f /etc/wireguard/wg0.conf ]; then
  echo "NOTE: WireGuard not configured yet. Run: sudo /usr/local/sbin/bootstrap_sensitive.sh"
fi

final_message: "Provisioned: SSH on 2522 (socket activation), key-only auth, WG-gated forwarding, zsh+oh-my-zsh+timesavers+starship-ready, gh/git, CIFS/NFS, eza/bat/htop, terminfo, fonts, optional Hetzner Storage Box."
